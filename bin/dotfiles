#!/usr/bin/env python
# -*- coding: utf-8 -*-

'''
   @wookayin's              ███████╗██╗██╗     ███████╗███████╗
   ██████╗  █████╗ ████████╗██╔════╝██║██║     ██╔════╝██╔════╝
   ██╔══██╗██╔══██╗╚══██╔══╝█████╗  ██║██║     █████╗  ███████╗
   ██║  ██║██║  ██║   ██║   ██╔══╝  ██║██║     ██╔══╝  ╚════██║
   ██████╔╝╚█████╔╝   ██║   ██║     ██║███████╗███████╗███████║
   ╚═════╝  ╚════╝    ╚═╝   ╚═╝     ╚═╝╚══════╝╚══════╝╚══════╝
bin/dotfiles -- a command-line helper for managing dotfiles
https://dotfiles.wook.kr
'''

from __future__ import print_function

import functools
import platform
import subprocess
import collections
import os.path
import sys


def _wrap_colors(ansicode):
    return (lambda msg: ansicode + str(msg) + '\033[0m')
GRAY   = _wrap_colors("\033[0;37m")
WHITE  = _wrap_colors("\033[1;37m")
RED    = _wrap_colors("\033[0;31m")
GREEN  = _wrap_colors("\033[0;32m")
YELLOW = _wrap_colors("\033[0;33m")
BLUE   = _wrap_colors("\033[0;34m")


_command_args = collections.defaultdict(list)

def add_argument(*args, **kwargs):
    def decorator(func):
        _command_args[func.__name__].append((args, kwargs))

        @functools.wraps(func)
        def f(*args, **kwargs):
            ret = func(*args, **kwargs)
            return ret
        return f
    return decorator

###############################################################################################

@add_argument('--skip-zplug', action='store_true', help='Skip zplug/zgen update')
@add_argument('--skip-vimplug', action='store_true', help='Skip vim-plug update')
def update(skip_zplug=False,
           skip_vimplug=False):
    '''Update the dotfiles from github.'''

    dotfiles_dir = os.path.expanduser('~/.dotfiles')

    def _git_head():
        ret = subprocess.check_output('git rev-parse --short HEAD',
                                      shell=True, cwd=dotfiles_dir)
        if sys.version_info[0] >= 3 and isinstance(ret, bytes):
            ret = ret.decode('utf-8')
        return ret.strip()

    git_old_head = _git_head()

    install_args = ""
    if skip_zplug: install_args += "--skip-zplug "
    if skip_vimplug: install_args += "--skip-vimplug "

    # TODO: check if current branch is master
    action = '''
        set -x
        cd ~/.dotfiles
        git stash
        git pull --ff-only && python install.py {install_args}
        git stash pop
    '''.format(install_args=install_args)
    subprocess.call(['bash', '-c', action])

    git_new_head = _git_head()

    if git_old_head == git_new_head:
        print(YELLOW('[*] dotfiles is up-to-date ({}).'.format(git_new_head)))
    else:
        print(GREEN('[*] Update complete!'))
        print(WHITE('Changelog: {}..{}'.format(git_old_head, git_new_head)))
        subprocess.call('git log --pretty=oneline --abbrev-commit {}..{}'\
                        .format(git_old_head, git_new_head),
                        shell=True, cwd=dotfiles_dir)


def open_github():
    '''Open the github repository in the web browser.'''

    import webbrowser
    webbrowser.open("https://dotfiles.wook.kr", new=0)


@add_argument('target', nargs='+', help='target package to install, see ~/.dotfiles/etc/linux-locals.sh for list')
@add_argument('--force', action='store_true')
def install_local(target, force):
    '''
    Install local packages as specified in /etc/linux-locals.sh.
    Available only in Linux.
    '''

    if platform.system() != 'Linux':
        print("Error: only available on linux systems")
        sys.exit(1)

    if not isinstance(target, (list, tuple)):
        target = [target]

    dotfiles_dir = os.path.expanduser('~/.dotfiles')

    for t in target:
        ret = subprocess.call(
            './etc/linux-locals.sh install_{} {}'.format(
                t, '--force' if force else ''),
            shell=True, cwd=dotfiles_dir
        )

        if ret != 0: # error
            return ret

        print(GREEN("[*] Installation successful: {}\n".format(t)))

    print(GREEN("\n[*] Installation(s) successful. You may need to run ") + \
          WHITE("`exec zsh`") + \
          GREEN(" to reflect changes in PATH."))

def main():
    COMMANDS = {
        'update': update,
        'github': open_github,
        'install' : install_local,
    }

    from argparse import ArgumentParser, RawTextHelpFormatter
    parser = ArgumentParser(description=__doc__,
                            formatter_class=RawTextHelpFormatter)
    subparsers = parser.add_subparsers(title='Available commands',
                                       dest="command")

    for (cmd, action) in COMMANDS.items():
        sp = subparsers.add_parser(cmd, help=action.__doc__)
        for (args, kwargs) in _command_args.get(action.__name__, []):
            sp.add_argument(*args, **kwargs)

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(1)
    else:
        args = parser.parse_args()

    kwargs = vars(args)
    command = kwargs.pop('command')
    ret = COMMANDS[command](**kwargs)

    if ret:  # non-zero exit code
        sys.exit(ret)



if __name__ == '__main__':
    main()
